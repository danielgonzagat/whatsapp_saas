name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: pgvector/pgvector:pg15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: whatsapp_saas_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: Install Dependencies (Backend)
      run: |
        cd backend
        npm ci

    - name: Install Dependencies (Worker)
      run: |
        cd worker
        npm ci

    - name: Install Dependencies (Frontend)
      run: |
        cd frontend
        npm ci

    - name: Install Dependencies (E2E)
      run: |
        cd e2e
        npm ci

    - name: Run Backend Tests + Build
      run: |
        cd backend
        echo "DATABASE_URL=postgresql://postgres:password@localhost:5432/whatsapp_saas_test" > .env
        echo "JWT_SECRET=test_secret" >> .env
        echo "REDIS_URL=redis://localhost:6379" >> .env

        npx prisma generate
        npx prisma migrate deploy

        npm run test
        npm run build

    - name: Lint + Build Frontend
      run: |
        cd frontend
        npm run lint
        npm run build

    - name: Build Worker
      run: |
        cd worker
        npm run build

    - name: Install Playwright Browsers
      run: |
        cd e2e
        npx playwright install --with-deps chromium

    - name: Start Services (Backend/Worker/Frontend)
      env:
        DATABASE_URL: postgresql://postgres:password@localhost:5432/whatsapp_saas_test
        REDIS_URL: redis://localhost:6379
        JWT_SECRET: test_secret
        OPENAI_API_KEY: e2e-dummy-key
        NEXT_PUBLIC_API_URL: http://localhost:3001
        BACKEND_URL: http://localhost:3001
        NEXTAUTH_URL: http://localhost:3000
        NEXTAUTH_SECRET: test_secret
      run: |
        set -e

        cd backend
        node dist/src/bootstrap > /tmp/backend.log 2>&1 &
        echo $! > /tmp/backend.pid
        cd - >/dev/null

        cd worker
        node dist/bootstrap.js > /tmp/worker.log 2>&1 &
        echo $! > /tmp/worker.pid
        cd - >/dev/null

        cd frontend
        PORT=3000 npm run start > /tmp/frontend.log 2>&1 &
        echo $! > /tmp/frontend.pid
        cd - >/dev/null

        echo "Aguardando backend..."
        backend_ok=0
        for i in {1..60}; do
          if curl -sf http://localhost:3001/health >/dev/null; then backend_ok=1; echo "✓ backend"; break; fi
          sleep 2
        done
        if [ "$backend_ok" -ne 1 ]; then
          echo "Backend não ficou pronto"; tail -n 200 /tmp/backend.log || true; exit 1
        fi

        echo "Aguardando worker..."
        worker_ok=0
        for i in {1..60}; do
          if curl -sf http://localhost:3003/health >/dev/null; then worker_ok=1; echo "✓ worker"; break; fi
          sleep 2
        done
        if [ "$worker_ok" -ne 1 ]; then
          echo "Worker não ficou pronto"; tail -n 200 /tmp/worker.log || true; exit 1
        fi

        echo "Aguardando frontend..."
        frontend_ok=0
        for i in {1..60}; do
          if curl -sf http://localhost:3000/login >/dev/null; then frontend_ok=1; echo "✓ frontend"; break; fi
          sleep 2
        done
        if [ "$frontend_ok" -ne 1 ]; then
          echo "Frontend não ficou pronto"; tail -n 200 /tmp/frontend.log || true; exit 1
        fi

    - name: Run E2E (Playwright)
      env:
        PW_TEST_HTML_REPORT_OPEN: never
        DATABASE_URL: postgresql://postgres:password@localhost:5432/whatsapp_saas_test
        REDIS_URL: redis://localhost:6379
        JWT_SECRET: test_secret
        OPENAI_API_KEY: e2e-dummy-key
        NEXT_PUBLIC_API_URL: http://localhost:3001
        BACKEND_URL: http://localhost:3001
      run: |
        cd e2e
        npm test

    - name: Upload Playwright Report (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: |
          e2e/playwright-report
          e2e/test-results

    - name: Stop Services
      if: always()
      run: |
        for f in /tmp/frontend.pid /tmp/worker.pid /tmp/backend.pid; do
          if [ -f "$f" ]; then
            pid=$(cat "$f")
            kill "$pid" 2>/dev/null || true
          fi
        done

        echo "--- backend.log ---"; tail -n 200 /tmp/backend.log || true
        echo "--- worker.log ---"; tail -n 200 /tmp/worker.log || true
        echo "--- frontend.log ---"; tail -n 200 /tmp/frontend.log || true
